<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>TON Treasury Tools</title>
</head>
<body>
  <h1>TON Treasury Viewer + BOC Decoder</h1>

  <!-- Section 1: Treasury contract address -->
  <h3>View Treasury Contract</h3>
  <input type="text" id="addressInput" placeholder="Enter treasury address" size="60" />
  <button id="viewAddressBtn">View in TonViewer</button>

  <!-- Section 2: BoC Decoder -->
  <h3>Decode BOC Manually</h3>
  <textarea id="bocInput" placeholder="Paste hex BOC here" rows="6" cols="80"></textarea><br />
  <button id="decodeBtn">Decode</button>

  <!-- All results go here -->
  <h3>Results</h3>
  <div id="resultsContainer"></div>

  <script type="module">
    import { Cell, Address } from 'https://esm.sh/@ton/core@0.58.1';
    import { Buffer } from 'https://esm.sh/buffer';

    function parseBoc(buffer) {
      const root = Cell.fromBoc(buffer)[0];
      const slice = root.beginParse();

      const totalShares = slice.loadUintBig(32);
      const totalPendingJettons = slice.loadUintBig(32);

      const investorListCell = slice.loadRef();
      const investorSlice = investorListCell.beginParse();

      let investors = [];
      while (investorSlice.remainingBits > 0) {
        try {
          const addr = investorSlice.loadAddress();
          const share = investorSlice.loadUint(32);
          const pendingJetton = investorSlice.loadUint(32);
          investors.push({ addr, share, pendingJetton });
        } catch (e) {
          break;
        }
      }

      let html = `<p><strong>Total Shares:</strong> ${totalShares.toString()}</p>`;
      html += `<p><strong>Total Pending Jettons:</strong> ${totalPendingJettons.toString()}</p>`;
      html += `<p><strong>Investor Count:</strong> ${investors.length}</p>`;

      if (investors.length > 0) {
        html += '<table border="1" cellspacing="0" cellpadding="4"><tr><th>Address</th><th>Share</th><th>Pending Jetton</th></tr>';
        for (const investor of investors) {
          html += `<tr><td>${investor.addr.toString()}</td><td>${investor.share}</td><td>${investor.pendingJetton}</td></tr>`;
        }
        html += '</table>';
      }

      return html;
    }

    function createResultBlock(title, viewerLink, htmlContent) {
      const container = document.createElement('div');
      container.style.border = '1px solid #ccc';
      container.style.padding = '10px';
      container.style.margin = '15px 0';
      container.style.backgroundColor = '#f9f9f9';

      const heading = document.createElement('h4');
      heading.textContent = title;

      const viewer = document.createElement('div');
      viewer.innerHTML = viewerLink;

      const content = document.createElement('div');
      content.innerHTML = htmlContent;

      container.appendChild(heading);
      container.appendChild(viewer);
      container.appendChild(content);

      document.getElementById('resultsContainer').appendChild(container);
    }

    // Button: View address and fetch holders
    document.getElementById('viewAddressBtn').onclick = async () => {
      const address = document.getElementById('addressInput').value.trim();
      if (!address) return;

      const viewerUrl = `https://testnet.tonviewer.com/${address}?section=holders`;
      const viewerLink = `<a href="${viewerUrl}" target="_blank">ðŸ”— View Holders in TonViewer</a>`;

      try {
        const response = await fetch(`https://testnet.tonapi.io/v1/jettons/${address}/holders`);
        if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
        const data = await response.json();

        let htmlContent = `<p><strong>Total Holders:</strong> ${data.total}</p>`;
        if (data.holders && data.holders.length > 0) {
          htmlContent += '<table border="1" cellspacing="0" cellpadding="4"><tr><th>Address</th><th>Balance</th></tr>';
          data.holders.forEach(holder => {
            htmlContent += `<tr><td>${holder.address}</td><td>${holder.balance}</td></tr>`;
          });
          htmlContent += '</table>';
        } else {
          htmlContent += '<p>No holders found.</p>';
        }

        createResultBlock(`Holders for: ${address}`, viewerLink, htmlContent);
      } catch (e) {
        createResultBlock(`Holders for: ${address}`, viewerLink, `<p style="color:red;">Error: ${e.message}</p>`);
      }
    };

    // Button: manual decode
    document.getElementById('decodeBtn').onclick = () => {
      const hex = document.getElementById('bocInput').value.trim();
      if (!hex) return;

      try {
        const buffer = Buffer.from(hex, 'hex');
        const htmlContent = parseBoc(buffer);
        createResultBlock('Manual BOC Decode', '', htmlContent);
      } catch (e) {
        createResultBlock('Manual BOC Decode', '', `<p style="color:red;">Error parsing BOC: ${e.message}</p>`);
      }
    };
  </script>
</body>
</html>